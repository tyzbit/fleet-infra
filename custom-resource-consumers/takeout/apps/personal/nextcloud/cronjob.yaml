apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: nextcloud-cron
  namespace: personal
spec:
  successfulJobsHistoryLimit: 1
  schedule: "*/15 * * * *"
  jobTemplate:
    spec:
      activeDeadlineSeconds: 900
      backoffLimit: 2
      completions: 1
      parallelism: 1
      template:
        spec:
          # affinity:
          #   podAffinity:
          #     requiredDuringSchedulingIgnoredDuringExecution:
          #     - labelSelector:
          #         matchExpressions:
          #         - key: app
          #           operator: In
          #           values:
          #           - nextcloud
          #       topologyKey: kubernetes.io/hostname
          containers:
          - name: nextcloud-cron
            image: nextcloud:21.0.8
            imagePullPolicy: Always
            command: ["su", "-p", "www-data", "-s", "/bin/sh", "-c", "php -f /var/www/html/cron.php"]
            volumeMounts:
              - mountPath: "/var/www/html"
                name: nextcloud-data
            resources:
              requests:
                cpu: 50m
              limits:
                memory: 256Mi
          restartPolicy: Never
          volumes:
            - name: nextcloud-data
              persistentVolumeClaim:
                claimName: nextcloud-data-nas
          imagePullSecrets:
            - name: docker-hub
