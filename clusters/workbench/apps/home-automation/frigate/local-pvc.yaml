# ---
# apiVersion: volsync.backube/v1alpha1
# kind: ReplicationSource
# metadata:
#   name: frigate-db-local-path
#   namespace: source
# spec:
#   sourcePVC: frigate-db-local-path
#   trigger:
#     schedule: "*/5 * * * *"
#   rsync:
#     sshKeys: volsync-nas
#     address: nas.home.arpa:/volume1/workbench_backups/frigate/
#     copyMethod: Snapshot
# ---
apiVersion: volsync.backube/v1alpha1
kind: ReplicationDestination
metadata:
  name: frigate-db-local-path
  namespace: home-automation
spec:
  rsyncTLS:
    copyMethod: Snapshot
    capacity: 10Gi
    keySecret: volsync-nas
    accessModes: ["ReadWriteOnce"]
    storageClassName: democratic-local
    volumeSnapshotClassName: democratic-local
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: frigate-db-local-path
  namespace: home-automation
spec:
  accessModes: [ReadWriteOnce]
  dataSourceRef:
    kind: ReplicationDestination
    apiGroup: volsync.backube
    name: frigate-db-nas
  resources:
    requests:
      storage: 10Gi
  storageClassName: democratic-local
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: &name test-volsync
  namespace: home-automation
spec:
  replicas: 1
  selector:
    matchLabels:
      app: *name
  serviceName: *name
  template:
    metadata:
      labels:
        app: *name
    spec:
      containers:
        - name: *name
          image: debian
          imagePullPolicy: Always
          command: [tail, -f, /dev/null]
          volumeMounts:
            - name: *name
              mountPath: /data
      volumes:
        - name: *name
          persistentVolumeClaim:
            claimName: frigate-db-local-path
