# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s/helm-charts/app-template-4.1.1/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app revolt-dev
  namespace: flux-system
spec:
  releaseName: *app
  targetNamespace: personal
  timeout: 15m
  interval: 2m0s
  chart:
    spec:
      chart: app-template
      version: "4.6.0"
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
  values:
    # -- Used for anchor references further down, has no effect here
    reusable:
      l: &longhorncontroller
        type: statefulset
        annotations: {reloader.stakater.com/auto: "true"}
        pod: {nodeSelector: {longhorn: primary}}
      d: &deploymentcontroller
        type: deployment
        annotations: {reloader.stakater.com/auto: "true"}
      c: &configmount
        path: /Revolt.toml
        readOnly: true
        subPath: Revolt.toml
    # -- END

    controllers:
      "mongo":
        <<: *longhorncontroller
        replicas: 1 # active longhorn
        containers:
          revolt-mongo:
            image:
              repository: docker.io/mongo
              tag: 8.0.17
              pullPolicy: Always
            # args: [--replSet,rs0]
            env: {HOSTNAME: revolt-dev-mongo}
            resources: {requests: {cpu: 10m},limits: {memory: 512Mi}}
      "redis":
        <<: *longhorncontroller
        replicas: 1 # active longhorn
        containers:
          revolt-redis:
            image:
              repository: docker.io/eqalpha/keydb
              tag: alpine_x86_64_v6.3.4
              pullPolicy: Always
            resources: {requests: {cpu: 10m},limits: {memory: 128Mi}}
      "rabbit":
        <<: *longhorncontroller
        replicas: 1 # active longhorn
        containers:
          revolt-rabbit:
            image:
              repository: docker.io/rabbitmq
              tag: 4
              pullPolicy: Always
            env: &env
              # Kinda just got lazy here
              RABBITMQ_DEFAULT_USER: rabbitmq
              RABBITMQ_DEFAULT_PASS: ${revolt_dev_rabbitmq_password}
              MINIO_ROOT_USER: minioautumn
              MINIO_ROOT_PASSWORD: ${revolt_dev_minio_password}
              RUST_LOG: debug
            resources: {requests: {cpu: 10m},limits: {memory: 256Mi}}
      "minio":
        <<: *longhorncontroller
        replicas: 1 # active longhorn
        containers:
          revolt-minio:
            command: [minio,server,/data]
            #   - /bin/sh
            #   - -c
            #   - |
            #     while ! /usr/bin/mc ready minio; do
            #       /usr/bin/mc config host add minio http://127.0.0.1:9000 minioautumn $(MINIO_ROOT_PASSWORD)
            #       echo 'Waiting minio...'
            #       sleep 1
            #     done && \
            #     /usr/bin/mc mb minio/revolt-uploads &
                # minio server /data
            image:
              repository: docker.io/minio/minio
              tag: latest
              pullPolicy: Always
            env:
              <<: *env
            resources: {requests: {cpu: 10m},limits: {memory: 1Gi}}
      "api":
        <<: *deploymentcontroller
        replicas: 1
        containers:
          revolt-api:
            image:
              repository: ghcr.io/stoatchat/api
              tag: 20251023-1
              pullPolicy: Always
            resources: {requests: {cpu: 10m},limits: {memory: 256Mi}}
      "events":
        <<: *deploymentcontroller
        replicas: 1
        containers:
          revolt-events:
            image:
              repository: ghcr.io/stoatchat/events
              tag: 20251023-1
              pullPolicy: Always
            resources: {requests: {cpu: 10m},limits: {memory: 128Mi}}
      "web":
        <<: *deploymentcontroller
        replicas: 1
        containers:
          revolt-web:
            command:
              - /bin/sh
              - -c
              - |
                cd /usr/src/app
                filepath=dist/assets/RevoltApp*.js
                echo "Doing find and replace for compiled constants"
                echo "Change these in the command for the web container"
                echo 
                echo "NOTE: this is only for the frontend, backend config"
                echo "      still needs to be set and in sync too."
                echo
                for setting in \
                  icons=5_000_000 \
                  emojis=500_000 \
                  banners=12_000_000 \
                  avatars=8_000_000 \
                  backgrounds=12_000_000 \
                ; do
                  type=$(echo $setting|cut -d= -f1)
                  setting=$(echo $setting|cut -d= -f2)
                  echo "Setting all $type to $setting"
                  sed -i.bak -E "s/(\{[^\}]+fileType:\"$type\"[^\}]+maxFileSize):[a-z0-6]+/\1:$setting/g" $filepath
                done
                echo "Done with find and replace, starting yarn..."
                yarn start:inject
            image:
              repository: ghcr.io/revoltchat/client
              tag: master
              pullPolicy: Always
            env:
              REVOLT_PUBLIC_URL: https://test.${chat_domain}/api
            resources: {requests: {cpu: 10m},limits: {memory: 256Mi}}
      "file-server":
        <<: *deploymentcontroller
        replicas: 1
        containers:
          revolt-file-server:
            image:
              repository: ghcr.io/stoatchat/file-server
              tag: 20251023-1
              pullPolicy: Always
            resources: {requests: {cpu: 10m},limits: {memory: 1Gi}}
            env:
              <<: *env
      "proxy":
        <<: *deploymentcontroller
        replicas: 1
        containers:
          revolt-proxy:
            image:
              repository: ghcr.io/stoatchat/proxy
              tag: 20251023-1
              pullPolicy: Always
            resources: {requests: {cpu: 10m},limits: {memory: 512Mi}}
      "gifbox":
        <<: *deploymentcontroller
        replicas: 1
        containers:
          revolt-gifbox:
            image:
              repository: ghcr.io/stoatchat/gifbox
              tag: 20251023-1
              pullPolicy: Always
            resources: {requests: {cpu: 10m},limits: {memory: 512Mi}}
      "crond":
        <<: *deploymentcontroller
        replicas: 1
        containers:
          revolt-crond:
            image:
              repository: ghcr.io/stoatchat/crond
              tag: 20251023-1
              pullPolicy: Always
            resources: {requests: {cpu: 10m},limits: {memory: 128Mi}}
      "pushd":
        <<: *deploymentcontroller
        replicas: 1
        containers:
          revolt-pushd:
            image:
              repository: ghcr.io/stoatchat/pushd
              tag: 20251023-1
              pullPolicy: Always
            resources: {requests: {cpu: 10m},limits: {memory: 128Mi}}
      "livekit":
        <<: *deploymentcontroller
        replicas: 1
        containers:
          revolt-livekit:
            image:
              repository: ghcr.io/stoatchat/livekit-server
              tag: v1.9.6
              pullPolicy: Always
            args: ["--config","/etc/livekit.yaml"]
            resources: {requests: {cpu: 10m},limits: {memory: 128Mi}}

    persistence:
      "mongo":
        existingClaim: revolt-dev-mongo-longhorn-database
        advancedMounts: {mongo: {revolt-mongo: [path: /data/db] } }
      "rabbit":
        existingClaim: revolt-dev-rabbit-longhorn-database
        advancedMounts: {rabbit: {revolt-rabbitmq: [path: /var/lib/rabbitmq]}}
      "minio":
        existingClaim: revolt-dev-minio-nas
        advancedMounts: {minio: {revolt-minio: [path: /data]}}
      "redis":
        existingClaim: revolt-dev-redis-nas
        advancedMounts: {redis: {revolt-redis: [path: /data]}}
      "config":
        name: revolt-dev
        type: configMap
        advancedMounts:
          api: {revolt-api: [*configmount]}
          events: {revolt-events: [*configmount]}
          file-server: {revolt-file-server: [*configmount]}
          gifbox: {revolt-gifbox: [*configmount]}
          proxy: {revolt-proxy: [*configmount]}
          crond: {revolt-crond: [*configmount]}
          pushd: {revolt-pushd: [*configmount]}
          livekit:
            revolt-livekit:
              -  path: /etc/livekit.yaml
                 readOnly: true
                 subPath: livekit.yaml

    service:
      "mongo":
        controller: mongo
        type: ClusterIP
        ports: {mongo: {port: 27017}}
      "redis":
        controller: redis
        type: ClusterIP
        ports: {redis: {port: 6379}}
      "rabbit":
        controller: rabbit
        type: ClusterIP
        ports: {rabbit: {port: 5672}}
      "minio":
        controller: minio
        type: ClusterIP
        ports: {minio: {port: 9000}}
      "web":
        controller: web
        type: ClusterIP
        ports: {http: {port: 5000}}
      "api":
        controller: api
        type: ClusterIP
        ports: {http: {port: 14702}}
      "events":
        controller: events
        type: ClusterIP
        ports: {http: {port: 14703}}
      "file-server":
        controller: file-server
        type: ClusterIP
        ports: {http: {port: 14704}}
      "proxy":
        controller: proxy
        type: ClusterIP
        ports: {http: {port: 14705}}
      "livekit":
        controller: livekit
        type: ClusterIP
        ports:
          connect: {port: 7880}
          rtc-1: {port: 12321}
          rtc-2: {port: 12322}
          rtc-3: {port: 12323}
          rtc-4: {port: 12324}
          rtc-5: {port: 12325}
          rtc-6: {port: 12326}
          rtc-7: {port: 12327}
          rtc-8: {port: 12328}
          rtc-9: {port: 12329}
          rtc-10: {port: 12330}
          rtc-11: {port: 12331}
          rtc-12: {port: 12332}
          rtc-13: {port: 12333}
          rtc-14: {port: 12334}
          rtc-15: {port: 12335}
          rtc-16: {port: 12336}
          rtc-17: {port: 12337}
          rtc-18: {port: 12338}
          rtc-19: {port: 12339}
          rtc-20: {port: 12340}

    # -- This is complex because it replaces Caddy
    ingress:
      "revolt":
        className: nginx
        annotations:
          cert-manager.io/cluster-issuer: letsencrypt
          nginx.ingress.kubernetes.io/proxy-body-size: 250m
          nginx.ingress.kubernetes.io/proxy-connect-timeout: "30"
          nginx.ingress.kubernetes.io/proxy-read-timeout: "2592000" # 1 week
          nginx.ingress.kubernetes.io/proxy-send-timeout: "2592000"
          nginx.ingress.kubernetes.io/use-regex: "true"
          nginx.ingress.kubernetes.io/rewrite-target: /$2
          external-dns.alpha.kubernetes.io/cloudflare-proxied: "true"
          external-dns.alpha.kubernetes.io/target: ${cloudflared_tunnel_uuid}.cfargotunnel.com
        hosts:
          - host: &host test.${chat_domain}
            paths:
              - path: "/api(/)?(.*)"
                pathType: ImplementationSpecific
                service:
                  identifier: api

              - path: "/ws(/)?(.*)"
                pathType: ImplementationSpecific
                service:
                  identifier: events

              - &autumn
                path: "/autumn(/)?(.*)" # will change to file-server eventually
                pathType: ImplementationSpecific
                service:
                  identifier: file-server
              - {<<: *autumn, path: "/(/)?(attachments.*)"}
              - {<<: *autumn, path: "/(/)?(avatars.*)"}
              - {<<: *autumn, path: "/(/)?(backgrounds.*)"}
              - {<<: *autumn, path: "/(/)?(icons.*)"}
              - {<<: *autumn, path: "/(/)?(banners.*)"}
              - {<<: *autumn, path: "/(/)?(emojis.*)"}

              - path: "/proxy(/)?(.*)"
                pathType: ImplementationSpecific
                service:
                  identifier: proxy

              - path: "/(/)?(.*)"
                pathType: ImplementationSpecific
                service:
                  identifier: web
        tls:
          - hosts:
              - *host
            secretName: *host
