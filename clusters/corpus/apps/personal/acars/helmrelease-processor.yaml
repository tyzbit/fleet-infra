# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s/helm-charts/app-template-3.7.3/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app acars-processor
  namespace: flux-system
spec:
  targetNamespace: personal
  releaseName: *app
  interval: 15m
  chart:
    spec:
      chart: app-template
      version: "3.7.3"
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
  values:
    common_settings: &common_settings
      type: statefulset
      annotations:
        reloader.stakater.com/auto: "true"

    controllers:
      acars-processor-1:
        <<: *common_settings
        nameOverride: "1"
        replicas: 1 # active nas
        containers:
          acars-processor-1:
            image:
              repository: ghcr.io/tyzbit/acars-processor
              tag: latest
            env:
              ACARSHUB_HOST: acars-acarshub
              ACARSHUB_PORT: "15550"
              ACARSHUB_VDLM2_HOST: acars-acarshub
              ACARSHUB_VDLM2_PORT: "15555"
              TAR1090_URL: &tar1090 http://adsb-ultrafeeder
              ANNOTATE_ACARS: "true"
              ANNOTATE_VDLM2: "true"
              LOGLEVEL: debug
              TAR1090_REFERENCE_GEOLOCATION: &location ${my_latitude},${my_longitude}
            envFrom:
              - secretRef:
                  name: acars-processor
            resources:
              requests:
                cpu: 10m
                memory: 256Mi
              limits:
                memory: 256Mi

      acars-processor-2:
        <<: *common_settings
        nameOverride: "2"
        replicas: 1 # active nas
        containers:
          acars-processor-2:
            image:
              repository: ghcr.io/tyzbit/acars-processor
              tag: latest
            env:
              ACARSHUB_HOST: acars-acarshub
              ACARSHUB_PORT: "15550"
              ACARSHUB_VDLM2_HOST: acars-acarshub
              ACARSHUB_VDLM2_PORT: "15555"
              ANNOTATE_ACARS: "true"
              ANNOTATE_VDLM2: "true"
              TAR1090_URL: *tar1090
              LOGLEVEL: debug
              TAR1090_REFERENCE_GEOLOCATION: *location
              FILTER_CRITERIA_HAS_TEXT: "true"
              NEW_RELIC_CUSTOM_EVENT_TYPE: CustomACARSHumanMessages
              # FILTER_CRITERIA_DICTIONARY_PHRASE_LENGTH_MINIMUM: "2"
              FILTER_OPENAI_MODEL: gpt-4o-mini
              FILTER_OPENAI_PROMPT: >-
                You are an expert in identifying natural language.
                Does this message have a message at the end that was definitely
                written by a person?
              # FILTER_OPENAI_APIKEY: (set in envFrom)
              ACARS_ANNOTATOR_SELECTED_FIELDS: >-
                acarsAircraftTailCode
                acarsFrequencyMHz
                acarsMessageText
                acarsMessageFrom
              VDLM2_ANNOTATOR_SELECTED_FIELDS: >-
                vdlm2FrequencyHz
                acarsAircraftTailCode
                acarsMessageText
                acarsMessageFrom
              TAR1090_ANNOTATOR_SELECTED_FIELDS: >-
                tar1090AircraftDistanceMi
                tar1090AircraftAltimeterGeometricFeet
            envFrom:
              - secretRef:
                  name: acars-processor2
            resources:
              requests:
                cpu: 10m
                memory: 128Mi
              limits:
                memory: 128Mi

      acars-processor-3:
        <<: *common_settings
        nameOverride: "3"
        replicas: 1 # active nas
        containers:
          acars-processor-3:
            image:
              repository: ghcr.io/tyzbit/acars-processor
              tag: latest
            env:
              ACARSHUB_HOST: acars-acarshub
              ACARSHUB_PORT: "15550"
              ACARSHUB_VDLM2_HOST: acars-acarshub
              ACARSHUB_VDLM2_PORT: "15555"
              ANNOTATE_ACARS: "true"
              ANNOTATE_VDLM2: "true"
              LOGLEVEL: debug
              FILTER_CRITERIA_HAS_TEXT: "true"
              # FILTER_CRITERIA_DICTIONARY_PHRASE_LENGTH_MINIMUM: "2"
              # FILTER_OLLAMA_URL: http://media2.home.arpa:11434
              FILTER_OLLAMA_URL: http://ollama:11434
              FILTER_OLLAMA_MODEL: gemma3:4b
              # FILTER_OLLAMA_MAX_PREDICTION_TOKENS: "256" # not needed
              FILTER_OLLAMA_PROMPT: >-
                This message was sent from an aircraft or from air traffic
                dispatch. Rarely, messages like these have a personal message
                included which sometimes has acronyms, abbreviations and
                technical terms, usually related to air travel. If the message
                starts out with "DISP" or "MSG FROM DISP" it definitely has a
                personal message because DISP stands for DISPATCH. For example,
                "MSG FROM DISP WAS THAT A TYPO QM YOU WERE FILED FOR FL290" is
                a personal message to an aircraft from dispatch.
                "APU//29AUG//1341//1001//0//ECU//ECU//START PURGE VALVE" is a
                snippet from a message that did not have a personal message. The
                repeated separator characters such as "," "/" "-" or others
                indicate the message is a generated report without any
                personal message included. Also, START PURGE VALVE preceeded by
                what looks like a numerical report suggests the message is not
                personal. The absence of punctuation common for English 
                sentences is not an indicator whether a personal message is 
                present. Finally, an overall high proportion of alphanumeric
                characters that does not have a contiguous section of plain 
                English is a strong indicator the message is not personal. 
                With these criteria in mind, does this message contain a 
                personal message?
              ACARS_ANNOTATOR_SELECTED_FIELDS: >-
                acarsMessageText
              VDLM2_ANNOTATOR_SELECTED_FIELDS: >-
                acarsMessageText
            envFrom:
              - secretRef:
                  name: acars-processor3
            resources:
              requests:
                cpu: 10m
                memory: 128Mi
              limits:
                memory: 128Mi
