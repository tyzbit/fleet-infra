# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s/helm-charts/app-template-3.7.3/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app acars-processor
  namespace: flux-system
spec:
  targetNamespace: personal
  releaseName: *app
  interval: 15m
  chart:
    spec:
      chart: app-template
      version: "3.7.3"
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
  values:
    common_settings: &common_settings
      type: statefulset
      annotations:
        reloader.stakater.com/auto: "true"

    controllers:
      acars-processor-1:
        <<: *common_settings
        nameOverride: "1"
        replicas: 1 # active nas
        containers:
          acars-processor-1:
            image:
              repository: ghcr.io/tyzbit/acars-processor
              tag: latest
            env:
              ACARSHUB_HOST: acars-acarshub
              ACARSHUB_PORT: "15550"
              ACARSHUB_VDLM2_HOST: acars-acarshub
              ACARSHUB_VDLM2_PORT: "15555"
              TAR1090_URL: &tar1090 http://adsb-ultrafeeder
              ANNOTATE_ACARS: "true"
              ANNOTATE_VDLM2: "true"
              LOGLEVEL: debug
              TAR1090_REFERENCE_GEOLOCATION: &location ${my_latitude},${my_longitude}
            envFrom:
              - secretRef:
                  name: acars-processor
            resources:
              requests:
                cpu: 10m
                memory: 256Mi
              limits:
                memory: 256Mi

      acars-processor-2:
        <<: *common_settings
        nameOverride: "2"
        replicas: 1 # active nas
        containers:
          acars-processor-2:
            image:
              repository: ghcr.io/tyzbit/acars-processor
              tag: latest
            env:
              ACARSHUB_HOST: acars-acarshub
              ACARSHUB_PORT: "15550"
              ACARSHUB_VDLM2_HOST: acars-acarshub
              ACARSHUB_VDLM2_PORT: "15555"
              ANNOTATE_ACARS: "true"
              ANNOTATE_VDLM2: "true"
              TAR1090_URL: *tar1090
              LOGLEVEL: debug
              TAR1090_REFERENCE_GEOLOCATION: *location
              FILTER_CRITERIA_HAS_TEXT: "true"
              NEW_RELIC_CUSTOM_EVENT_TYPE: CustomACARSHumanMessages
              # FILTER_CRITERIA_DICTIONARY_PHRASE_LENGTH_MINIMUM: "2"
              FILTER_OPENAI_MODEL: gpt-4o-mini
              # FILTER_OPENAI_PROMPT: >-
              #   You are an expert in identifying natural language.
              #   Does this message have a message at the end that was definitely
              #   written by a person?
              FILTER_OPENAI_PROMPT: &prompt |
                This message was sent between aircraft and air traffic control.
                Rarely, messages like these have sections with communication 
                that is interesting to air travel enthusiasts. The communication 
                may start out with a small amount of informational data or 
                message headers but then have a semantically meaningful message
                that was typed by ATC or a pilot.
                
                Air travel enthusiasts want to see human-typed messages,
                not computer generated reports. They know some acronyms that 
                the general public might not know. The messages they care about
                most often read like instant messages or text messages because 
                they are short and have misspellings or acronyms. 
                
                If a message comes across as emotional or dramatic in any way,
                including but not limited to friendly, angry, alarmed, scared 
                or stressed, then it is definitely something air travel enthusiasts
                want to see because they are interested in messages that are 
                dramatic, comedic or otherwise show the interactions of people
                behind the scenes of air travel.
                
                If the message refers to a serious situation like an
                emergency, life vests, passengers (the shorthand PAX is used),
                comments or questions about bad weather (known as SIGMET, 
                weather in general is referred to as WX), unusual situations
                (an aircraft with only one passenger or a request that looks
                like it's for a VIP), devices on the aircraft (such as coffee
                makers or lavatories - shorthand: LAV) or otherwise reads as a
                person reporting an important situation, air travel enthusiasts
                definitely want to see that.
                
                If the message has any of these, then air travel enthusiasts
                want to see it:
                - DISP
                - MSG FROM
                - FREETEXT
                
                Here's an example message air travel enthusiasts want to see: 
                ```
                MSG FROM DISP WAS THAT A TYPO QM YOU WERE FILED FOR FL290
                ```
                
                This is interesting to them because:
                
                - The message is to or from dispatch, which is usually
                important communication and is always person-to-person.
                - The message is about a typo. Air travel enthusiasts are 
                interested in seeing "behind the scenes", which includes
                mistakes or dramatic situations.
                
                This is a harder message, but it is still considered interesting:
                
                ```
                C314           3HELLO
                OIL IS AT 10.0/10.0
                THANK YOU




                ```
                
                Air travel enthusiasts wouldn't know what C314 means,
                but if the message has any greetings or pleasantries such as 
                "HELLO", "HEY", or "THNAK YOU", that's human communication and
                they want to see it. It is also a short message, which can
                happen sometimes for messages they want to see because pilots
                and ATC want to minimize the amount of time they spend typing
                due to the critical, time-sensitive nature of their jobs.
                
                This is the last example of meaningful communication:
                ```
                3A01 OPSCTL 0364/14 KRSW/KHVN .N804VL
                TELL ROMAN TO SLOW DOWN
                LOL WE ARE GONNA
                TRY AND MAKE SOME TIME
                ```
                
                The message starts off with a small amount of information that
                is like a TO/FROM field in an email but the presence of OPS
                means it's probably a message to or from Operations but it still
                could be computer generated. The message then has a humorous and
                friendly message asking Roman to slow down and adding that they
                are going to try to make some time. 
                
                Since automatically generated messages don't use people's names, 
                English shorthand (LOL) or inform about planned actions, this is
                definitely something air travel enthusiasts want to see.
                
                This is a message an air travel enthusiast is not interested in:
                
                ```
                POSN36188W077155,GUILD,022722,335,DEEEZ,023833,ESCHR,M49,27459,
                154A785RESREQ/AK,1158AF6PER/PR1326,303,360,153,,0,53,,M56,180,,,
                P40,P0,36090,,1173,31729A4RESREQ/AK,1158AF6FPN/FNAAL2816/RP:DA:
                KDCA:AA:KJAX:CR:KDCAKJAX:R:19O(26O):D:AMEEE1.SCOOB:A:LUNNI1.ESENT
                :AP:ILSY26..GUILD,N36188W077150.Q409.SESUE..ESENT,N32095W080551:
                V:ESENT,,AA2800,5F52
                ```
                
                This is virtually entirely raw data that likely requires
                software or careful reading and parsing of the dense information
                that a hobbyist would not care about. Most messages by volume 
                will be automatically generated by software intended to be 
                ingested by other air travel related software familiar with the
                format. Messages with a lot of alphanumeric characters or groups of
                characters that do not have semantically meaningful words
                is not something air travel enthusiasts care about.
                
                Another message that air travel enthusiasts don't want to see:
                
                ```
                POSN 37.177W 75.729,  71,024200,29004,28040,  63,-39,031712,
                KPHLN 371037W 754344,-------,024200,29004, ,      , ,M 39,
                28040  63,  71,
                ```
                
                This is all data and numbers. An air travel hobbyist would
                prefer to see things pilots and air traffic controllers have
                manually written. If the message is long (hundreds of characters
                or more) and is just letters and/or numbers that are not 
                semantically meaningful English sentences, then it is not of
                interest to air travel enthusiasts.
                
                Here are some examples of text that, if present, means the
                message is not relevant to air traffic enthusiasts:
                - ROB SLAT DIS PROX
                - FPN/
                - HOWGOZIT
                
                Omission of punctuation you might expect for English sentences
                is not a strong indicator whether an interesting message is 
                present because these messages are typed quickly.
                
                There may be commas, periods spaces and newlines in
                unusual places or there might be a lot of extra whitespace.
                ALL CAPS is very common. Newlines might also be in the middle
                of words.
                
                Considering all of these factors, is this message something
                that an air travel enthusiast would be interested to see?
              # FILTER_OPENAI_APIKEY: (set in envFrom)
              ACARS_ANNOTATOR_SELECTED_FIELDS: >-
                acarsAircraftTailCode
                acarsFrequencyMHz
                acarsMessageText
                acarsMessageFrom
              VDLM2_ANNOTATOR_SELECTED_FIELDS: >-
                vdlm2FrequencyHz
                acarsAircraftTailCode
                acarsMessageText
                acarsMessageFrom
              TAR1090_ANNOTATOR_SELECTED_FIELDS: >-
                tar1090AircraftDistanceMi
                tar1090AircraftAltimeterGeometricFeet
            envFrom:
              - secretRef:
                  name: acars-processor2
            resources:
              requests:
                cpu: 10m
                memory: 128Mi
              limits:
                memory: 128Mi

      acars-processor-3:
        <<: *common_settings
        nameOverride: "3"
        replicas: 1 # active nas
        containers:
          acars-processor-3:
            image:
              repository: ghcr.io/tyzbit/acars-processor
              tag: latest
            env:
              ACARSHUB_HOST: acars-acarshub
              ACARSHUB_PORT: "15550"
              ACARSHUB_VDLM2_HOST: acars-acarshub
              ACARSHUB_VDLM2_PORT: "15555"
              ANNOTATE_ACARS: "true"
              ANNOTATE_VDLM2: "true"
              LOGLEVEL: debug
              FILTER_CRITERIA_HAS_TEXT: "true"
              # FILTER_CRITERIA_DICTIONARY_PHRASE_LENGTH_MINIMUM: "2"
              # FILTER_OLLAMA_URL: http://media2.home.arpa:11434
              # FILTER_OLLAMA_URL: http://ollama:11434
              FILTER_OLLAMA_URL: http://ollama.home.arpa
              # FILTER_OLLAMA_MODEL: gemma3:4b
              FILTER_OLLAMA_MODEL: llama3.2
              FILTER_OLLAMA_FILTER_ON_FAILURE: "true"
              ACARSHUB_MAX_CONCURRENT_REQUESTS_PER_SUBSCRIBER: "4"
              # FILTER_OLLAMA_MAX_PREDICTION_TOKENS: "256" # not needed
              FILTER_OLLAMA_PROMPT: *prompt
              ACARS_ANNOTATOR_SELECTED_FIELDS: >-
                acarsMessageText
              VDLM2_ANNOTATOR_SELECTED_FIELDS: >-
                acarsMessageText
            envFrom:
              - secretRef:
                  name: acars-processor3
            resources:
              requests:
                cpu: 10m
                memory: 128Mi
              limits:
                memory: 128Mi