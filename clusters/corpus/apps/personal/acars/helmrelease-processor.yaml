# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s/helm-charts/app-template-3.7.3/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app acars-processor
  namespace: flux-system
spec:
  targetNamespace: personal
  releaseName: *app
  interval: 15m
  chart:
    spec:
      chart: app-template
      version: "3.7.3"
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
  values:
    common_settings: &common_settings
      type: statefulset
      annotations:
        reloader.stakater.com/auto: "true"

    controllers:
      acars-processor-1:
        <<: *common_settings
        nameOverride: "1"
        replicas: 1
        containers:
          acars-processor-1:
            image:
              repository: ghcr.io/tyzbit/acars-processor
              tag: latest
            resources:
              requests:
                cpu: 10m
                memory: 512Mi
              limits:
                memory: 512Mi

      acars-processor-2:
        <<: *common_settings
        nameOverride: "2"
        replicas: 1
        containers:
          acars-processor-2:
            image:
              repository: ghcr.io/tyzbit/acars-processor
              tag: latest
            resources:
              requests:
                cpu: 10m
                memory: 512Mi
              limits:
                memory: 512Mi

      acars-processor-3:
        <<: *common_settings
        nameOverride: "3"
        replicas: 0
        containers:
          acars-processor-3:
            image:
              repository: ghcr.io/tyzbit/acars-processor
              tag: latest
            resources:
              requests:
                cpu: 10m
                memory: 512Mi
              limits:
                memory: 512Mi

      acars-processor-4:
        <<: *common_settings
        nameOverride: "4"
        replicas: 0
        containers:
          acars-processor-4:
            image:
              repository: ghcr.io/tyzbit/acars-processor
              tag: latest
            resources:
              requests:
                cpu: 10m
                memory: 512Mi
              limits:
                memory: 512Mi

    persistence:
      config-1:
        type: secret
        name: acars-processor-1-config
        advancedMounts:
          acars-processor-1: 
            acars-processor-1: &config [{path: /, readOnly: true, subPath: /config.yaml}]
      config-2:
        type: secret
        name: acars-processor-2-config
        advancedMounts:
          acars-processor-2: 
            acars-processor-2: *config
      config-3:
        type: secret
        name: acars-processor-3-config
        advancedMounts:
          acars-processor-3: 
            acars-processor-3: *config
