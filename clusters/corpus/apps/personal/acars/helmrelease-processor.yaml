# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s/helm-charts/app-template-3.7.3/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app acars-processor
  namespace: flux-system
spec:
  targetNamespace: personal
  releaseName: *app
  interval: 15m
  chart:
    spec:
      chart: app-template
      version: "3.7.3"
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
  values:
    common_settings: &common_settings
      type: statefulset
      annotations:
        reloader.stakater.com/auto: "true"

    controllers:
      acars-processor-1:
        <<: *common_settings
        nameOverride: "1"
        replicas: 1 # active nas
        containers:
          acars-processor-1:
            image:
              repository: ghcr.io/tyzbit/acars-processor
              tag: latest
            env:
              ACARSHUB_HOST: acars-acarshub
              ACARSHUB_PORT: "15550"
              ACARSHUB_VDLM2_HOST: acars-acarshub
              ACARSHUB_VDLM2_PORT: "15555"
              TAR1090_URL: &tar1090 http://adsb-ultrafeeder
              ANNOTATE_ACARS: "true"
              ANNOTATE_VDLM2: "true"
              LOGLEVEL: debug
              TAR1090_REFERENCE_GEOLOCATION: &location ${my_latitude},${my_longitude}
            envFrom:
              - secretRef:
                  name: acars-processor
            resources:
              requests:
                cpu: 10m
                memory: 256Mi
              limits:
                memory: 256Mi

      acars-processor-2:
        <<: *common_settings
        nameOverride: "2"
        replicas: 1 # active nas
        containers:
          acars-processor-2:
            image:
              repository: ghcr.io/tyzbit/acars-processor
              tag: latest
            env:
              ACARSHUB_HOST: acars-acarshub
              ACARSHUB_PORT: "15550"
              ACARSHUB_VDLM2_HOST: acars-acarshub
              ACARSHUB_VDLM2_PORT: "15555"
              ANNOTATE_ACARS: "true"
              ANNOTATE_VDLM2: "true"
              TAR1090_URL: *tar1090
              LOGLEVEL: debug
              TAR1090_REFERENCE_GEOLOCATION: *location
              FILTER_CRITERIA_HAS_TEXT: "true"
              NEW_RELIC_CUSTOM_EVENT_TYPE: CustomACARSHumanMessages
              # FILTER_CRITERIA_DICTIONARY_PHRASE_LENGTH_MINIMUM: "2"
              FILTER_OPENAI_MODEL: gpt-4o-mini
              # FILTER_OPENAI_PROMPT: >-
              #   You are an expert in identifying natural language.
              #   Does this message have a message at the end that was definitely
              #   written by a person?
              FILTER_OPENAI_PROMPT: &prompt |
                This message was sent between aircraft and air traffic control.
                Rarely, messages like these have sections with communication 
                that is interesting to air travel enthusiasts. The communication 
                may be included after various types of sort generated reports
                or message headers. If the message starts out with "DISP",
                "MSG FROM DISP" or references "OPS" or "OPSCTL" it definitely
                has a message interesting to air travel enthusiasts because DISP
                stands for DISPATCH and OPS stands for OPERATIONS. 
                Likewise, "--FREETEXT--" means the message was typed by a 
                person. Air travel enthusiasts care the most about human-typed 
                messages, not computer generated reports. They know acronyms
                that the general public might know, and probably won't know
                most other terminology used in messages.

                
                For example: 
                ```
                MSG FROM DISP WAS THAT A TYPO QM YOU WERE FILED FOR FL290
                ```

                This is interesting to air travel enthusiasts because
                - The message is to or from dispatch, which is usually
                important communication.
                - The message concerns a typo. Air travel enthusiasts are 
                interested in seeing "behind the scenes", which includes
                mistakes or dramatic situations.
                - Air travel enthusiasts may not know what FL290 means but
                because there aren't many acronyms or technical lingo, they
                can still understand what the message is saying.

                This is a harder message, but it is still
                considered interesting:

                ```
                C314           3HELLO
                OIL IS AT 10.0/10.0
                THANK YOU




                ```

                Air travel enthusiasts wouldn't know what C314 means,
                but if the message has any greetings or pleasantries such as 
                "HELLO", "HEY", or "THNAK YOU", it is now unambiguously clear 
                that this message contains interesting communication. It is also
                a short message, which is common because pilots and ATC want to
                minimize the amount of time they spend typing due to the
                critical nature of their jobs.

                Also, if the message sounds dramatic such as referring to an
                emergency, life vests, passengers (the shorthand PAX is used),
                comments or questions about bad weather (known as SIGMET, 
                weather in general is referred to as WX), or reads as a person
                reporting a serious situation, it is definitely interesting to
                air travel enthusiasts.

                This is the last example of meaningful communication:
                ```
                3A01 OPSCTL 0364/14 KRSW/KHVN .N804VL
                TELL ROMAN TO SLOW DOWN
                LOL WE ARE GONNA
                TRY AND MAKE SOME TIME
                ```

                The message starts off with information that might be used to
                route the message which enthusiasts won't know what they mean.
                The presence of OPS, though, means it's probably a message
                to Operations, but it still might be computer generated. Then
                the author writes a humorous and friendly message asking Roman
                to slow down and adding that they are going to try to make some
                time. Since automatically generated messages don't use names, 
                English shorthand (LOL) or inform about planned actions, this is
                definitely interesting to enthusiasts.

                This does not have interesting information to a hobbyist:

                ```
                POSN36188W077155,GUILD,022722,335,DEEEZ,023833,ESCHR,M49,27459,
                154A785RESREQ/AK,1158AF6PER/PR1326,303,360,153,,0,53,,M56,180,,,
                P40,P0,36090,,1173,31729A4RESREQ/AK,1158AF6FPN/FNAAL2816/RP:DA:
                KDCA:AA:KJAX:CR:KDCAKJAX:R:19O(26O):D:AMEEE1.SCOOB:A:LUNNI1.ESENT
                :AP:ILSY26..GUILD,N36188W077150.Q409.SESUE..ESENT,N32095W080551:
                V:ESENT,,AA2800,5F52
                ```
                
                This is virtually entirely technical information that requires
                software a hobbyist would not have to parse. Most messages will
                be automatically generated by software intended to be ingested 
                by other air travel related software familiar with the format.
                
                Another message that does not have interesting communication:
                ```
                POSN 37.177W 75.729,  71,024200,29004,28040,  63,-39,031712,
                KPHLN 371037W 754344,-------,024200,29004, ,      , ,M 39,
                28040  63,  71,
                ```

                This is mostly data and numbers. An air travel hobbyist would
                prefer to see things pilots and air traffic controllers have
                manually written.

                Here are some examples of text that, if present, means the
                message is not relevant to air traffic enthusiasts:
                - ROB SLAT DIS PROX
                - FPN/
                - HOWGOZIT

                Punctuation you might expect for English sentences being omitted
                is not a strong indicator whether an interesting message is 
                present. There may be commas, periods spaces and newlines in
                unusual places or there might be a lot of extra whitespace.
                Personal communication will most likely be in ALL CAPS. 
                Newlines might also be in the middle of words.
                
                Based on the information provided, does this message have 
                communication that is interesting to air travel enthusiasts?
              # FILTER_OPENAI_APIKEY: (set in envFrom)
              ACARS_ANNOTATOR_SELECTED_FIELDS: >-
                acarsAircraftTailCode
                acarsFrequencyMHz
                acarsMessageText
                acarsMessageFrom
              VDLM2_ANNOTATOR_SELECTED_FIELDS: >-
                vdlm2FrequencyHz
                acarsAircraftTailCode
                acarsMessageText
                acarsMessageFrom
              TAR1090_ANNOTATOR_SELECTED_FIELDS: >-
                tar1090AircraftDistanceMi
                tar1090AircraftAltimeterGeometricFeet
            envFrom:
              - secretRef:
                  name: acars-processor2
            resources:
              requests:
                cpu: 10m
                memory: 128Mi
              limits:
                memory: 128Mi

      acars-processor-3:
        <<: *common_settings
        nameOverride: "3"
        replicas: 1 # active nas
        containers:
          acars-processor-3:
            image:
              repository: ghcr.io/tyzbit/acars-processor
              tag: latest
            env:
              ACARSHUB_HOST: acars-acarshub
              ACARSHUB_PORT: "15550"
              ACARSHUB_VDLM2_HOST: acars-acarshub
              ACARSHUB_VDLM2_PORT: "15555"
              ANNOTATE_ACARS: "true"
              ANNOTATE_VDLM2: "true"
              LOGLEVEL: debug
              FILTER_CRITERIA_HAS_TEXT: "true"
              # FILTER_CRITERIA_DICTIONARY_PHRASE_LENGTH_MINIMUM: "2"
              # FILTER_OLLAMA_URL: http://media2.home.arpa:11434
              # FILTER_OLLAMA_URL: http://ollama:11434
              FILTER_OLLAMA_URL: https://ollama.home.arpa
              # FILTER_OLLAMA_MODEL: gemma3:4b
              FILTER_OLLAMA_MODEL: llama3.2
              FILTER_OLLAMA_FILTER_ON_FAILURE: "true"
              # FILTER_OLLAMA_MAX_PREDICTION_TOKENS: "256" # not needed
              FILTER_OLLAMA_PROMPT: *prompt
              ACARS_ANNOTATOR_SELECTED_FIELDS: >-
                acarsMessageText
              VDLM2_ANNOTATOR_SELECTED_FIELDS: >-
                acarsMessageText
            envFrom:
              - secretRef:
                  name: acars-processor3
            resources:
              requests:
                cpu: 10m
                memory: 128Mi
              limits:
                memory: 128Mi