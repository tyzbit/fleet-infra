# yaml-language-server: $schema=https://raw.githubusercontent.com/tyzbit/acars-processor/refs/heads/main/schema.json

ACARSProcessorSettings:
  ColorOutput: true
  LogLevel: debug
  LogHideTimestamps: true
  Database:
    Enabled: true
    ConnectionString: "${acars_proc_2_db_dsn}"
    Type: mariadb
  ACARSHub:
    MaxConcurrentRequests: 1
    ACARS:
      Host: &acarshubhost acars-acarshub
      Port: 15550

    VDLM2:
      Host: *acarshubhost
      Port: 15555

Steps:
  - Annotate:
      Tar1090:
        URL: http://adsb-ultrafeeder
        ReferenceGeolocation: "${my_latitude},${my_longitude}"

  - Send:
      NewRelic:
        APIKey: "${new_relic_license_key}"
        CustomEventType: CustomACARS

  - Filter:
      SelectedFields:
        # Only common convenience fields
        - ACARSProcessor.ACARSDramaTailNumberLink
        - ACARSProcessor.AircraftDistanceMi
        - ACARSProcessor.FlightNumber
        - ACARSProcessor.FrequencyHz
        - ACARSProcessor.FrequencyMHz
        - ACARSProcessor.From
        - ACARSProcessor.ImageLink
        - ACARSProcessor.Label
        - ACARSProcessor.MessageText
        - ACARSProcessor.Mode
        - ACARSProcessor.PhotosLink
        - ACARSProcessor.SignalLeveldBm
        - ACARSProcessor.StationId
        - ACARSProcessor.TailCode
        - ACARSProcessor.ThumbnailLink
        - ACARSProcessor.TrackingLink
        - ACARSProcessor.TranslateLink
        - ACARSProcessor.UnixTimestamp

  # - Filter: { Builtin: { DictionaryPhraseLengthMinimum: 2 } }
  - Filter: { Builtin: { HasText: true } }

  - Filter:
      Builtin:
        Invert: true
        RequireTerms:
          Count: 1
          Terms:
            - /FTMLDR
            - RESREQ
            - POSRPT
            - AUTOMATED FLT OPS
            - UNFCTRD
            - USADCXA
            - "#DFREQ"
            - ET EXP TIME
            - AGFSR
            - PRG/
            - APU START <
            - "<"
            - ">"
            - +++
            - TAKEOFF_
            - .CSV
            - ------------
            # Airport DISP messages
            - ATIS INFO
            - TAXI AND SHUTDOWN THE APU
            - YOUR HELP IS APPRECIATED.
            - ADVS YOU
            - YOU HAVE INFO
            - BIRDS IN THE VICINITY
            - BIRD ACTIVITY
            - READBACK ALL
            - NOTICE TO AIRMEN
            - ALL GATES UNDER
            - S-E TAXI
            ###################
            - CODE BLEED STATUS
            - PREFLIGHT BRIEF
            - MDC REPORT
            - EXCEEDANCE REPORT
            - SNAPSHOT REPORT
            - SYSTEM PARAMETERS
            - ENGINE TREND
            - "CAROUSEL:"
            - FILENAME
            - CREW CONNECTING GATE INFO
            - MUST LAND ON RWY
            - REQUEST GATE ASSIGNMENT ETA
            - Equation ID

  - Send:
      NewRelic:
        APIKey: "${new_relic_license_key}"
        CustomEventType: CustomACARSRequireTermsResults
      # Discord:
      #   Embed: true
      #   EmbedColorFacetFields: [ACARSProcessor.ACARSDramaTailNumberLink]
      #   # EmbedColorGradientField: ACARSProcessor.LLMProcessedNumber
      #   URL: "${acars_development_discord_webhook}"
      #   FormatText: true
      #   FormatTimestamps: true

  - Filter:
      Builtin:
        PreviousMessageSimilarity:
          Similarity: 0.90
          MaximumLookBehind: 1000
          DontFilterIfLonger: true

  - Filter:
      Ollama:
        Model: &ollamamodel qwen3:30b-a3b
        URL: &ollamaurl http://sophie.home.arpa:11434
        FilterOnFailure: true
        MaxRetryAttempts: 2
        MaxRetryDelaySeconds: 5
        Timeout: 30
        Options: &ollamaopts [
            { Name: num_predict, Value: 150 }, # Maximum number of tokens (words, kinda) to generate
            { Name: temperature, Value: 0.4 }, # Creativity (0.0-2.0)
            { Name: top_p, Value: 0.2 }, # Answer diversity with top_k (0.0-1.0)
            { Name: top_k, Value: 20 }, # Answer diversity (ex 0-100)
            { Name: frequency_penalty, Value: 1.1 }, # Penalize repeated tokens (0-2.0)
            { Name: num_gpu, Value: 40 }, # Number of layers to offload to GPU
          ]
        # -----------------------------------------
        # 1,245 characters
        # 369 tokens https://token-calculator.net
        # -----------------------------------------
        UserPrompt: |
          You are reviewing air travel related messages from both humans and
          programatically generated sources and must forward only messages from
          humans.

          Human messages will have natural language (in English, Spanish,
          French) and might have misspellings or abbreviations like you might
          see in cell phone text messages. The words in these messages may have
          commas, periods or spaces separating words or might be missing spaces
          between words.

          DO forward if the message matches ANY of these rules:
          - Contains natural or colloquial language or prose which may also 
            contain technical terms or acronyms.
          - Greetings/sign-offs, for example: HI, HELLO, BONJOUR,
            GOOD MORNING/EVENING, THANK YOU/THANKS/THNKS/THX, BRGRDS, CHEERS,
            COPY/COPY THAT
          - A clear sentence/clause like WILL/IS/ARE/HAVE/NEED/CAN/PLEASE/
            QUESTION MARK followed by a verb, for example: PLEASE SEND WX.
          - Has /Q/ or QQ which is shorthand for asking a question in this 
            context.
          - Operational commentary or questions about passengers,crew,med,
            medical,booking,rebooking/ramp-gate,lavatories (abbreviation: LAV),
            seats or any other situation with a narrative or question.
          - Lists a desk number or has "DISPATCHER MSG"

          Based on these rules, should this message be forwarded?
      #      /no_think

  - Send:
      Discord:
        Embed: true
        EmbedColorFacetFields: [ACARSProcessor.From]
        # EmbedColorGradientField: ACARSProcessor.LLMProcessedNumber
        URL: "${acars_discord_webhook}"
        FormatText: true
        FormatTimestamps: true
        MessageGoTemplate: |
          -# From [{{index . "ACARSProcessor.TailCode"}}]({{index . "ACARSProcessor.TrackingLink"}}){{if ne "" (index . "ACARSProcessor.FlightNumber")}} on flight {{index . "ACARSProcessor.FlightNumber"}}{{else}}{{end}} <t:{{index . "ACARSProcessor.UnixTimestamp"}}:R>{{if ne 0.0 (index . "ACARSProcessor.AircraftDistanceMi")}} from {{printf "%.2f" (index . "ACARSProcessor.AircraftDistanceMi")}} miles away{{else}}{{end}}.
          ```
          {{index . "ACARSProcessor.MessageText"}}
          ```
          **Links**:
          [Translate this message]({{index . "ACARSProcessor.TranslateLink"}})
          [ACARSDrama messages from this aircraft]({{index . "ACARSProcessor.ACARSDramaTailNumberLink"}})
          [Aircraft Photos]({{index . "ACARSProcessor.PhotosLink"}})

  - Send:
      NewRelic:
        APIKey: "${new_relic_license_key}"
        CustomEventType: CustomACARSHumanMessages

  - Annotate:
      Ollama:
        Model: *ollamamodel
        URL: *ollamaurl
        MaxRetryAttempts: 2
        MaxRetryDelaySeconds: 5
        Timeout: 30
        Options: *ollamaopts
        UserPrompt: |
          Rate the prose from found in this message from pilots and ATC between
          1-100 for any emotions such as anger, frustration, elation
          complaining, gratitude, confusion, etc.

          - 1-40 should indicate the message reads as neutral.
          - 40-80 should indicate the message is emotional in some way.
          - 80-100 should indicate the message is very emotional.
    Filter: { Builtin: { LLMProcessedNumberAbove: 40 } }

  - Send:
      Discord:
        Embed: true
        # EmbedColorFacetFields: [ACARSProcessor.From]
        EmbedColorGradientField: ACARSProcessor.LLMProcessedNumber
        URL: "${acars_anger_discord_webhook}"
        # FormatText: true
        # FormatTimestamps: true
        MessageGoTemplate: |
          {{if eq (index . "ACARSProcessor.From") "Aircraft"}}From{{else}}To{{end}} [{{index . "ACARSProcessor.TailCode"}}]({{index . "ACARSProcessor.TrackingLink"}}){{if ne "" (index . "ACARSProcessor.FlightNumber")}} on flight {{index . "ACARSProcessor.FlightNumber"}}{{else}}{{end}} <t:{{index . "ACARSProcessor.UnixTimestamp"}}:R>{{if ne 0.0 (index . "ACARSProcessor.AircraftDistanceMi")}} from {{printf "%.2f" (index . "ACARSProcessor.AircraftDistanceMi")}} miles away{{else}}{{end}}.
          -# This message rated a {{index . "ACARSProcessor.LLMProcessedNumber"}} in terms of emotional content.

          ```
          {{index . "ACARSProcessor.MessageText"}}
          ```
          The LLM had this to say:
          ```
          {{index . "ACARSProcessor.LLMModelFeedbackText"}}
          ```

          **Links**:
          [Translate this message]({{index . "ACARSProcessor.TranslateLink"}})
          [ACARSDrama messages from this aircraft]({{index . "ACARSProcessor.ACARSDramaTailNumberLink"}})
          [Aircraft Photos]({{index . "ACARSProcessor.PhotosLink"}})
