# yaml-language-server: $schema=https://raw.githubusercontent.com/tyzbit/acars-processor/refs/heads/22-25-processing-steps/schema.json
##### yaml-language-server: $schema=https://raw.githubusercontent.com/tyzbit/acars-processor/refs/heads/main/schema.json

# Purpose: Testing with real messages and services, but
# development-labeled receivers
ACARSProcessorSettings:
  ColorOutput: true
  LogLevel: debug
  LogHideTimestamps: true
  Database:
    Enabled: true
    ConnectionString: "${acars_proc_2_db_dsn}"
    Type: mariadb
  ACARSHub:
    MaxConcurrentRequests: 1
    ACARS:
      Host: &acarshubhost acars-acarshub
      Port: 15550
      SelectedFields: &selectedfields
        - ACARSProcessor.ACARSDramaTailNumberLink
        - ACARSProcessor.FlightNumber
        - ACARSProcessor.FrequencyMhz
        - ACARSProcessor.From
        - ACARSProcessor.ImageLink
        - ACARSProcessor.MessageText
        - ACARSProcessor.PhotosLink
        - ACARSProcessor.SignalLeveldBm
        - ACARSProcessor.TailCode
        - ACARSProcessor.ThumbnailLink
        - ACARSProcessor.TrackingLink
        - ACARSProcessor.TranslateLink
        - ACARSProcessor.UnixTimestamp

    VDLM2:
      Host: *acarshubhost
      Port: 15555
      SelectedFields: *selectedfields

Steps:
  - Send:
      NewRelic:
        APIKey: "${new_relic_license_key}"
        CustomEventType: CustomACARS
  - Filter: { Builtin: { DictionaryPhraseLengthMinimum: 2 } }

  - Filter:
      Builtin:
        PreviousMessageSimilarity:
          Similarity: 0.90
          MaximumLookBehind: 100
          DontFilterIfLonger: true

  - Annotate:
      Tar1090:
        URL: http://adsb-ultrafeeder
        ReferenceGeolocation: "${my_latitude},${my_longitude}"

  - Filter:
      Ollama:
        Model: &ollamamodel qwen3:30b-a3b
        URL: &ollamaurl http://sophie.home.arpa:11434
        FilterOnFailure: true
        MaxRetryAttempts: 2
        MaxRetryDelaySeconds: 5
        Timeout: 30
        Options: &ollamaopts [
            { Name: num_predict, Value: 150 }, # Maximum number of tokens (words, kinda) to generate
            { Name: temperature, Value: 0.4 }, # Creativity (0.0-2.0)
            { Name: top_p, Value: 0.2 }, # Answer diversity with top_k (0.0-1.0)
            { Name: top_k, Value: 20 }, # Answer diversity (ex 0-100)
            { Name: frequency_penalty, Value: 1.1 }, # Penalize repeated tokens (0-2.0)
            { Name: num_gpu, Value: 40 }, # Number of layers to offload to GPU
          ]
        # -----------------------------------------
        # 7,907 characters
        # 1,543 tokens https://token-calculator.net
        # -----------------------------------------
        UserPrompt: |
          You are reviewing messages from both humans and programatically
          generated sources and must forward only the messages from humans.

          DO NOT forward if the message matches ANY of these rules:
          - Is uniformly structured with tables or extra spaces for formatting
            or has more than 10 periods, commas or other punctuation in a row.
          - Contains multiple segments with /M, /N, /P, /Q, /R, /S, /T, /V with
            no prose.
          - Starts with or contains more than one automated terms such as FLR/,
            FDR/, FPN/, POSRPT, POSN, CFDS, ACMS, AIDS, ATSU, MDC REPORT,
            EXCEEDANCE REPORT, ACARS AUTO, ENGINE TREND, ECAM 1/2, ECAM only
            lines, ATA, LRU, P/N, NOTAMS, SYSTEM PARAMETERS, ARQ, PREFLIGHT
            BRIEF, TAXI, CAROUSEL, FILENAME
          - Informational notices, such as ARRIVAL GATE INFORMATION, ATIS INFO,
            CREW/PAX CONNECTION notices and YOU HAVE INFO.
          - Almost entirely numerical data in a long sequence.

          DO forward if the message matches ANY of these rules:
          - Contains natural-language sentences or human prose which may 
            contain technical terms, acronyms but will always include a
            human-meaningful question or statement intended for another person.
            Human messages might have misspellings or abbreviations like you
            might see in cell phone text messages. The sentences commonly have
            commas or periods separating them.
          - Greetings/sign-offs, for example: HI, HELLO, BONJOUR,
            GOOD MORNING/EVENING, THANK YOU/THANKS/THX, BRGRDS, CHEERS,
            COPY/COPY THAT
          - A clear sentence/clause like WILL/IS/ARE/HAVE/NEED/CAN/PLEASE/
            QUESTION MARK followed by a verb, for example: PLEASE SEND WX.
          - Has /Q/ which is shorthand for asking a question in this messages.
          - Operational prose about passengers,crew,med,medical,booking,
            rebooking/ramp-gate or other situations with a narrative.
          - Lists a desk number.
          - Talks about LAV/SEAT

          Based on these rules, should this message be forwarded?
      #      /no_think

  - Filter:
      SelectedFields:
        - ACARSProcessor.ACARSDramaTailNumberLink
        - ACARSProcessor.AircraftDistanceMi
        - ACARSProcessor.FrequencyMhz
        - ACARSProcessor.From
        - ACARSProcessor.ImageLink
        - ACARSProcessor.MessageText
        - ACARSProcessor.PhotosLink
        - ACARSProcessor.SignalLeveldBm
        - ACARSProcessor.ThumbnailLink
        - ACARSProcessor.TrackingLink
        - ACARSProcessor.TranslateLink
        - ACARSProcessor.UnixTimestamp

  - Send:
      Discord:
        Embed: true
        EmbedColorFacetFields: [ACARSProcessor.ACARSDramaTailNumberLink]
        # EmbedColorGradientField: ACARSProcessor.LLMProcessedNumber
        URL: "${acars_discord_webhook}"
        FormatText: true
        FormatTimestamps: true

  - Send:
      NewRelic:
        APIKey: "${new_relic_license_key}"
        CustomEventType: CustomACARSHumanMessages

  - Annotate:
      Ollama:
        Model: *ollamamodel
        URL: *ollamaurl
        MaxRetryAttempts: 2
        MaxRetryDelaySeconds: 5
        Timeout: 30
        Options: *ollamaopts
        UserPrompt: |
          Rate the prose found in this message on a scale of 1-100 for
          emotionality with 1 indicating it reads as unemotional and/or neutral
          with no positive or negative emotions and 100 indicating it reads as
          extremely emotional in either a positive or negative way. Ignore any
          parts of the message that don't have natural prose, such as extra data
          with letters, numbers and possibly acronyms that are not part of any
          prose.

          Is the result greater than 40?

  - Filter:
      SelectedFields:
        - ACARSProcessor.ACARSDramaTailNumberLink
        - ACARSProcessor.From
        - ACARSProcessor.ImageLink
        - ACARSProcessor.LLMModelFeedbackText
        - ACARSProcessor.LLMProcessedNumber
        - ACARSProcessor.LLMYesNoQuestionAnswer
        - ACARSProcessor.MessageText
        - ACARSProcessor.PhotosLink
        - ACARSProcessor.SignalLeveldBm
        - ACARSProcessor.ThumbnailLink
        - ACARSProcessor.TrackingLink
        - ACARSProcessor.TranslateLink
        - ACARSProcessor.UnixTimestamp

  - Send:
      Discord:
        Embed: true
        # EmbedColorFacetFields: [ACARSProcessor.From]
        EmbedColorGradientField: ACARSProcessor.LLMProcessedNumber
        URL: "${acars_anger_discord_webhook}"
        FormatText: true
        FormatTimestamps: true
