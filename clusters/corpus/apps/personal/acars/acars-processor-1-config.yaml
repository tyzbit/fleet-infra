# yaml-language-server: $schema=https://raw.githubusercontent.com/tyzbit/acars-processor/refs/heads/main/schema.json

ACARSProcessorSettings:
  ColorOutput: true
  LogLevel: debug
  LogHideTimestamps: true
  Database:
    Enabled: true
    ConnectionString: "${acars_proc_2_db_dsn}"
    Type: mariadb
  ACARSHub:
    MaxConcurrentRequests: 1
    ACARS:
      Host: &acarshubhost acars-acarshub
      Port: 15550
      SelectedFields: &selectedfields
        - ACARSProcessor.ACARSDramaTailNumberLink
        - ACARSProcessor.FlightNumber
        - ACARSProcessor.FrequencyMhz
        - ACARSProcessor.From
        - ACARSProcessor.ImageLink
        - ACARSProcessor.MessageText
        - ACARSProcessor.PhotosLink
        - ACARSProcessor.SignalLeveldBm
        - ACARSProcessor.TailCode
        - ACARSProcessor.ThumbnailLink
        - ACARSProcessor.TrackingLink
        - ACARSProcessor.TranslateLink
        - ACARSProcessor.UnixTimestamp

    VDLM2:
      Host: *acarshubhost
      Port: 15555
      SelectedFields: *selectedfields

Steps:
  - Send:
      NewRelic:
        APIKey: "${new_relic_license_key}"
        CustomEventType: CustomACARS
  # - Filter: { Builtin: { DictionaryPhraseLengthMinimum: 2 } }
  - Filter: { Builtin: { HasText: true } }

  - Filter:
      Builtin:
        Invert: true
        RequireTerms:
          Count: 1
          Terms:
            - "="
            - /FTMLDR
            - "RDU "
            - RESREQ/
            - POSN
            - UNFCTRD
            - /USADCXA
            - "#DFREQ"
            - USADCXA
            - ET EXP TIME
            - AGFSR
            - PRG/
            - "APU START   "
            - ------------
            - TAXI AND SHUTDOWN THE APU
            - APU SHUTDOWN
            - ADVS YOU HAVE INFO
            - BIRDS IN THE VICINITY
            - BIRD ACTIVITY
            - READBACK ALL
            - NOTICE TO AIRMEN
            - CODE BLEED STATUS
            - PREFLIGHT BRIEF
            - MDC REPORT
            - SYSTEM PARAMETERS
            - EXCEEDANCE REPORT
            - ENGINE TREND
            - CAROUSEL
            - FILENAME
            - ARRIVAL GATE INFORMATION
            - ATIS INFO
            - CREW/PAX CONNECTION
            - CREW CONNECTING GATE INFO
            - MUST LAND ON RWY
            - REQUEST GATE ASSIGNMENT

  - Send:
      NewRelic:
        APIKey: "${new_relic_license_key}"
        CustomEventType: CustomACARSRequireTermsResults
      # Discord:
      #   Embed: true
      #   EmbedColorFacetFields: [ACARSProcessor.ACARSDramaTailNumberLink]
      #   # EmbedColorGradientField: ACARSProcessor.LLMProcessedNumber
      #   URL: "${acars_development_discord_webhook}"
      #   FormatText: true
      #   FormatTimestamps: true

  - Filter:
      Builtin:
        PreviousMessageSimilarity:
          Similarity: 0.90
          MaximumLookBehind: 1000
          DontFilterIfLonger: true

  - Annotate:
      Tar1090:
        URL: http://adsb-ultrafeeder
        ReferenceGeolocation: "${my_latitude},${my_longitude}"

  - Filter:
      Ollama:
        Model: &ollamamodel qwen3:30b-a3b
        URL: &ollamaurl http://sophie.home.arpa:11434
        FilterOnFailure: true
        MaxRetryAttempts: 2
        MaxRetryDelaySeconds: 5
        Timeout: 30
        Options: &ollamaopts [
            { Name: num_predict, Value: 150 }, # Maximum number of tokens (words, kinda) to generate
            { Name: temperature, Value: 0.4 }, # Creativity (0.0-2.0)
            { Name: top_p, Value: 0.2 }, # Answer diversity with top_k (0.0-1.0)
            { Name: top_k, Value: 20 }, # Answer diversity (ex 0-100)
            { Name: frequency_penalty, Value: 1.1 }, # Penalize repeated tokens (0-2.0)
            { Name: num_gpu, Value: 40 }, # Number of layers to offload to GPU
          ]
        # -----------------------------------------
        # 1,552 characters
        # 500 tokens https://token-calculator.net
        # -----------------------------------------
        UserPrompt: |
          You are reviewing messages from both humans and programatically
          generated sources and must forward only the messages from humans that
          contains prose. Human messages might have misspellings or abbreviations
          like you might see in cell phone text messages. The words in these
          messages may have commas or periods separating them instead of spaces.

          DO forward if the message matches ANY of these rules:
          - Contains natural-language sentences or human prose which may 
            contain technical terms or acronyms but 
          - Greetings/sign-offs, for example: HI, HELLO, BONJOUR,
            GOOD MORNING/EVENING, THANK YOU/THANKS/THX, BRGRDS, CHEERS,
            COPY/COPY THAT
          - A clear sentence/clause like WILL/IS/ARE/HAVE/NEED/CAN/PLEASE/
            QUESTION MARK followed by a verb, for example: PLEASE SEND WX.
          - Has /Q/ which is shorthand for asking a question in this messages.
          - Operational prose about passengers,crew,med,medical,booking,
            rebooking/ramp-gate, lavatories (abbreviatin: LAV), seats or other
            situations with a narrative.
          - Lists a desk number.

          DO NOT forward if the message matches ANY of these rules:
          - Is uniformly structured with one or more tables or by using spaces
            to format and does not have any prose in the message.
          - Has mostly numerical data without prose after it.

          Based on these rules, should this message be forwarded?
      #      /no_think

  - Filter:
      SelectedFields:
        - ACARSProcessor.ACARSDramaTailNumberLink
        - ACARSProcessor.AircraftDistanceMi
        - ACARSProcessor.FrequencyMhz
        - ACARSProcessor.From
        - ACARSProcessor.ImageLink
        - ACARSProcessor.MessageText
        - ACARSProcessor.PhotosLink
        - ACARSProcessor.SignalLeveldBm
        - ACARSProcessor.TailCode
        - ACARSProcessor.ThumbnailLink
        - ACARSProcessor.TrackingLink
        - ACARSProcessor.TranslateLink
        - ACARSProcessor.UnixTimestamp

  - Send:
      Discord:
        Embed: true
        EmbedColorFacetFields: [ACARSProcessor.ACARSDramaTailNumberLink]
        # EmbedColorGradientField: ACARSProcessor.LLMProcessedNumber
        URL: "${acars_discord_webhook}"
        FormatText: true
        FormatTimestamps: true

  - Send:
      NewRelic:
        APIKey: "${new_relic_license_key}"
        CustomEventType: CustomACARSHumanMessages

  - Annotate:
      Ollama:
        Model: *ollamamodel
        URL: *ollamaurl
        MaxRetryAttempts: 2
        MaxRetryDelaySeconds: 5
        Timeout: 30
        Options: *ollamaopts
        UserPrompt: |
          Rate the prose from found in this message from pilots and ATC between
          1-100 for any negative emotions such as anger, frustration,
          complaining, confusion or negative situations such as if MEDLINK  is 
          mentioned or any other aircraft-related emergency. Ignore any parts
          of the message that doesn't have communication prose.

          - 1-20 should indicate the message reads as neutral or positive.
          - 20-40 should indicate the message has a hint of negativity or
            describes an undesirable situation.
          - 40-60 should indicate the message tone is clearly negative or
            describes a bad situation.
          - 60-80 should indicate the message is complaining or expressing any
            negative emotion clearly and strongly.
          - 80-100 should indicate the message expresses very clear and very
            strong negative feelings of any type.

  - Filter:
      Builtin:
        LLMProcessedNumberAbove: 10

  - Send:
      Discord:
        Embed: true
        # EmbedColorFacetFields: [ACARSProcessor.From]
        EmbedColorGradientField: ACARSProcessor.LLMProcessedNumber
        URL: "${acars_anger_discord_webhook}"
        # FormatText: true
        # FormatTimestamps: true
        MessageGoTemplate: |
          # Emotional ({{ index . "ACARSProcessor.From" }}) ACARS Message

          From [{{ index . "ACARSProcessor.TailCode" }}]({{ index . "ACARSProcessor.TrackingLink" }}) <t:{{ index . "ACARSProcessor.UnixTimestamp" }}:R>

          -# This message rated a {{ index . "ACARSProcessor.LLMProcessedNumber" }} in terms of negative emotional content.

          ```
          {{ index . "ACARSProcessor.MessageText" }}
          ```

          **Links**:
          [Translate this message]({{ index . "ACARSProcessor.TranslateLink" }})
          [ACARSDrama messages from this aircraft]({{ index . "ACARSProcessor.ACARSDramaTailNumberLink" }})
          [Aircraft Photos]({{ index . "ACARSProcessor.PhotosLink" }})
