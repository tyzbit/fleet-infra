# yaml-language-server: $schema=https://raw.githubusercontent.com/tyzbit/acars-processor/refs/heads/main/schema.json

ACARSProcessorSettings:
  ColorOutput: true
  LogLevel: debug
  LogHideTimestamps: true
  Database:
    Enabled: true
    ConnectionString: "${acars_proc_2_db_dsn}"
    Type: mariadb
  ACARSHub:
    MaxConcurrentRequests: 1
    ACARS:
      Host: &acarshubhost acars-acarshub
      Port: 15550
    VDLM2:
      Host: *acarshubhost
      Port: 15555

Steps:
  # Add geolocation if my local ADS-B receiver has information for the aircraft
  - Annotate:
      Tar1090:
        URL: http://adsb-ultrafeeder
        ReferenceGeolocation: "${my_latitude},${my_longitude}"

  # Used for overall metrics and improving filters
  - Send:
      NewRelic:
        APIKey: "${new_relic_license_key}"
        CustomEventType: CustomACARS

  - Filter: { Builtin: { HasText: true } }
  # - Filter: { Builtin: { DictionaryPhraseLengthMinimum: 2 } }

  # The decoders often submit duplicate messages as they're able to reassemble
  # the messages
  - Filter:
      Builtin:
        PreviousMessageSimilarity:
          Similarity: 0.90
          MaximumLookBehind: 1000
          DontFilterIfLonger: false

  # These labels have not had a human-written message in the last 30 days
  - Filter:
      Builtin:
        Invert: true
        Labels:
          - "_d"
          - ""
          - ":;"
          - "12"
          - "16"
          - "21"
          - "22"
          - "32"
          - "33"
          - "36"
          - "43" # PAX REOPENED
          - "44"
          - "4N"
          - "5V"
          - "A9"
          - "B9"
          - "BA"
          - "C1"
          - "H1"
          - "Q0"
          - "SA"
          - "SQ"

  # # These labels have had human-written messages in the last 30 days
  # - Filter:
  #     Builtin:
  #       Labels:
  #         - "10"
  #         - "2A"
  #         - "87"
  #         - "85"
  #         - "81"
  #         - "1D"
  #         - "30"
  #         - "4R"
  #         - "41" # Lots of commas
  #         # Low concentration of human messages below
  #         - "11"
  #         - "3F"
  #         - "RA" # Tower, mostly routine messages
  #         - "5Z"
  #         - "1A"
  #         - "40" # LOTS of routine tower messages
  #         - "14" # Lots of "Good morning" and wheelchair requests
  #         - "20" # Low concentration, VDL2 judging by lowercase text
  #         - "80"
  #         - "1L" # Diluted with encrypted messages and data reports
  #         - "37"
  #         # Might be filterable
  #         - "34" # 1 PAX FROM CAB E TO CAB A 61B4
  #         - "39" # Less than 1% human messages
  #         - "83" # 0.7% human
  #         - "15" # 0.4% human
  #         - "10" # 0.4% human
  #         # Suggest filtering
  #         - "H1" # 0.002% human (human messages were validated)

  # These terms are present in routine messages that can be filtered
  - Filter:
      Builtin:
        Invert: true
        RequireTerms:
          Count: 1
          Terms:
            - /FTMLDR
            - RESREQ
            - POSRPT
            - AUTOMATED FLT OPS
            - UNFCTRD
            - USADCXA
            - "#DFREQ"
            - ET EXP TIME
            - AGFSR
            - PRG/
            - APU START <
            - "<"
            - ">"
            - +++
            - TAKEOFF_
            - .CSV
            - ------------
            # Airport DISP messages
            - ATIS INFO
            - TAXI AND SHUTDOWN THE APU
            - YOUR HELP IS APPRECIATED.
            - ADVS YOU
            - YOU HAVE INFO
            - BIRDS IN THE VICINITY
            - BIRD ACTIVITY
            - READBACK ALL
            - NOTICE TO AIRMEN
            - ALL GATES UNDER
            - S-E TAXI
            ###################
            - CODE BLEED STATUS
            - PREFLIGHT BRIEF
            - MDC REPORT
            - EXCEEDANCE REPORT
            - SNAPSHOT REPORT
            - SYSTEM PARAMETERS
            - ENGINE TREND
            - "CAROUSEL:"
            - FILENAME
            - CREW CONNECTING GATE INFO
            - MUST LAND ON RWY
            - REQUEST GATE ASSIGNMENT ETA
            - Equation ID

  # This is to analyze and improve my built-in filtering rules
  - Send:
      NewRelic:
        APIKey: "${new_relic_license_key}"
        CustomEventType: CustomACARSBuiltinOnly

  # Have local Ollama model look only for human-written messages
  - Filter:
      Ollama:
        Model: &ollamamodel qwen3:30b-a3b
        URL: &ollamaurl http://sophie.home.arpa:11434
        FilterOnFailure: true
        MaxRetryAttempts: 2
        MaxRetryDelaySeconds: 5
        Timeout: 30
        Options: &ollamaopts [
            { Name: num_predict, Value: 150 }, # Maximum number of tokens (words, kinda) to generate
            { Name: temperature, Value: 0.4 }, # Creativity (0.0-2.0)
            { Name: top_p, Value: 0.2 }, # Answer diversity with top_k (0.0-1.0)
            { Name: top_k, Value: 20 }, # Answer diversity (ex 0-100)
            { Name: frequency_penalty, Value: 1.1 }, # Penalize repeated tokens (0-2.0)
            { Name: num_gpu, Value: 40 }, # Number of layers to offload to GPU
          ]
        # -----------------------------------------
        # 955 characters
        # 283 tokens https://token-calculator.net
        # -----------------------------------------
        UserPrompt: |
          This message is either completely automatically generated or features
          a human-written message after some data. You must find the messages
          that have some human content.

          Human content in these messages might have misspellings, abbreviations
          or typos similar to cell phone text messages and may only be a few
          words. Human content will often have acronyms.

          DO forward if the message matches ANY of these criteria:
          - Contains any amount of natural or colloquial language or prose.
          - Contains a complaint, request or command.
          - Contains a greeting/sign-offs or their variations, for example: HI,
            HELLO, BONJOUR, GOOD MORNING/EVENING, THANK YOU/THANKS/THNKS/THX,
            BRGRDS/RGRDS, CHEERS, COPY/COPY THAT.
          - Has any prose content after the term FREETEXT or /TXT
          - Has /Q/ or QQ or QUESTION MARK which signifies a person is asking a
            question in this context.
          - Commentary or questions about aircraft passengers,crew,med,medical,
            medlink,booking,lavatories (abbreviation: LAV), seats, or other
            situations or events relating to air travel.
          - Lists a desk number or has DISPATCHER MSG.

          Based on these rules, should this message be forwarded?

  # This should be a human message, so send to my private Discord channel, with
  # fancy templating.
  - Send:
      Discord:
        Embed: true
        EmbedColorFacetFields: [ACARSProcessor.From]
        # EmbedColorGradientField: ACARSProcessor.LLMProcessedNumber
        URL: "${acars_discord_webhook}"
        FormatText: true
        FormatTimestamps: true
        MessageGoTemplate: |
          -# From [{{index . "ACARSProcessor.TailCode"}}]({{index . "ACARSProcessor.TrackingLink"}}){{if ne "" (index . "ACARSProcessor.FlightNumber")}} on flight {{index . "ACARSProcessor.FlightNumber"}}{{else}}{{end}} <t:{{index . "ACARSProcessor.UnixTimestamp"}}:R>{{if ne 0.0 (index . "ACARSProcessor.AircraftDistanceMi")}} from {{printf "%.2f" (index . "ACARSProcessor.AircraftDistanceMi")}} miles away{{else}}{{end}}.
          ```
          {{index . "ACARSProcessor.MessageText"}}
          ```
          **Links**:
          [Translate this message]({{index . "ACARSProcessor.TranslateLink"}})
          [ACARSDrama messages from this aircraft]({{index . "ACARSProcessor.ACARSDramaTailNumberLink"}})
          [Aircraft Photos]({{index . "ACARSProcessor.PhotosLink"}})

  # Also send to New Relic as a human message
  - Send:
      NewRelic:
        APIKey: "${new_relic_license_key}"
        CustomEventType: CustomACARSHumanMessages

  # Use Ollama again to evaluate the emotion of the message and filter in one
  # step
  - Annotate:
      Ollama:
        Model: *ollamamodel
        URL: *ollamaurl
        MaxRetryAttempts: 2
        MaxRetryDelaySeconds: 5
        Timeout: 30
        Options: *ollamaopts
        UserPrompt: |
          Rate the prose from found in this message from pilots and ATC between
          1-100 for any emotions such as anger, frustration, elation
          complaining, gratitude, confusion, etc.

          - 1-40 should indicate the message reads as neutral.
          - 40-80 should indicate the message is emotional in some way.
          - 80-100 should indicate the message is very emotional.
    Filter: { Builtin: { LLMProcessedNumberAbove: 40 } }

  # Send emotional messages to a different Discord channel
  - Send:
      Discord:
        Embed: true
        # EmbedColorFacetFields: [ACARSProcessor.From]
        EmbedColorGradientField: ACARSProcessor.LLMProcessedNumber
        URL: "${acars_anger_discord_webhook}"
        # FormatText: true
        # FormatTimestamps: true
        MessageGoTemplate: |
          {{if eq (index . "ACARSProcessor.From") "Aircraft"}}From{{else}}To{{end}} [{{index . "ACARSProcessor.TailCode"}}]({{index . "ACARSProcessor.TrackingLink"}}){{if ne "" (index . "ACARSProcessor.FlightNumber")}} on flight {{index . "ACARSProcessor.FlightNumber"}}{{else}}{{end}} <t:{{index . "ACARSProcessor.UnixTimestamp"}}:R>{{if ne 0.0 (index . "ACARSProcessor.AircraftDistanceMi")}} from {{printf "%.2f" (index . "ACARSProcessor.AircraftDistanceMi")}} miles away{{else}}{{end}}.
          -# This message rated a {{index . "ACARSProcessor.LLMProcessedNumber"}} in terms of emotional content.

          ```
          {{index . "ACARSProcessor.MessageText"}}
          ```
          The LLM had this to say:
          ```
          {{index . "ACARSProcessor.LLMModelFeedbackText"}}
          ```

          **Links**:
          [Translate this message]({{index . "ACARSProcessor.TranslateLink"}})
          [ACARSDrama messages from this aircraft]({{index . "ACARSProcessor.ACARSDramaTailNumberLink"}})
          [Aircraft Photos]({{index . "ACARSProcessor.PhotosLink"}})
