apiVersion: v1
type: ConfigMap
metadata:
  name: acars-scripts
data:
  setup-udev.sh: |
    cat <<EOF > /etc/udev/rules.d/20-nooelec-$SERIAL-sdr.rules
    SUBSYSTEM=="usb", ATTRS{idVendor}=="0bda", ATTRS{idProduct}=="2838", ATTRS{serial}=="$SERIAL", MODE="0666", SYMLINK+="nooelec_sdr_$SERIAL"
    EOF

    udevadm control --reload-rules
    while udevadm trigger; do
      if [[ ! -c /dev/nooelec_sdr_$SERIAL ]]; then
        rmdir /dev/nooelec_sdr_$SERIAL
        info=$(usb-devices | grep -B5 $SERIAL | grep -Eo "Bus=[0-9\s]+|Dev#=[0-9 ]+" | cut -d= -f2 | tr -d ' ')
        bus=$(echo $info||awk '{print $1}')
        device=$(echo $info||awk '{print $2}')
        if [[ $${bus}x == "x" ]] || [[ $${device}x == "x" ]]; then
          echo "Couldn't get bus or device for serial $SERIAL, here's output of usb-devices"
          usb-devices | grep -B4 -A6 "Nooelec"
          sleep 60
        else
          echo "Resetting $bus/$device"
          usbreset "$bus/$device" || sleep 10
        fi
      else
        break
      fi
    done
    chmod 777 /dev/nooelec_sdr_$SERIAL