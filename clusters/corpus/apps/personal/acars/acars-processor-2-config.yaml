# yaml-language-server: $schema=https://raw.githubusercontent.com/tyzbit/acars-processor/refs/heads/22-25-processing-steps/schema.json
##### yaml-language-server: $schema=https://raw.githubusercontent.com/tyzbit/acars-processor/refs/heads/main/schema.json

# Purpose: Testing with real messages and services, but
# development-labeled receivers
ACARSProcessorSettings:
  ColorOutput: true
  LogLevel: debug
  LogHideTimestamps: true
  Database:
    Enabled: true
    ConnectionString: "${acars_proc_2_db_dsn}"
    Type: mariadb
  ACARSHub:
    MaxConcurrentRequests: 1
    ACARS:
      Host: &acarshubhost acars-acarshub
      Port: 15550
      SelectedFields: &selectedfields
        - ACARSProcessor.ACARSDramaTailNumberLink
        - ACARSProcessor.FlightNumber
        - ACARSProcessor.FrequencyMhz
        - ACARSProcessor.From
        - ACARSProcessor.ImageLink
        - ACARSProcessor.MessageText
        - ACARSProcessor.PhotosLink
        - ACARSProcessor.SignalLeveldBm
        - ACARSProcessor.TailCode
        - ACARSProcessor.ThumbnailLink
        - ACARSProcessor.TrackingLink
        - ACARSProcessor.TranslateLink
        - ACARSProcessor.UnixTimestamp

    VDLM2:
      Host: *acarshubhost
      Port: 15555
      SelectedFields: *selectedfields

Steps:
  - Send: &newrelic
      NewRelic:
        APIKey: "${new_relic_license_key}"
        CustomEventType: CustomACARS
  - Filter: { Builtin: { DictionaryPhraseLengthMinimum: 2 } }
  # - Filter: {Builtin: {FreetextTermPresent: true}}

  - Filter:
      Builtin:
        PreviousMessageSimilarity:
          Similarity: 0.95
          MaximumLookBehind: 10000
          DontFilterIfLonger: true

  - Annotate:
      Tar1090:
        URL: http://adsb-ultrafeeder
        ReferenceGeolocation: "${my_latitude},${my_longitude}"

  - Filter:
      Ollama:
        Model: &ollamamodel qwen3:30b-a3b
        URL: &ollamaurl http://sophie.home.arpa:11434
        FilterOnFailure: true
        MaxRetryAttempts: 2
        MaxRetryDelaySeconds: 5
        Timeout: 30
        Options: &ollamaopts [
            { Name: num_predict, Value: 150 }, # Maximum number of tokens (words, kinda) to generate
            { Name: temperature, Value: 0.4 }, # Creativity (0.0-2.0)
            { Name: top_p, Value: 0.2 }, # Answer diversity with top_k (0.0-1.0)
            { Name: top_k, Value: 20 }, # Answer diversity (ex 0-100)
            { Name: frequency_penalty, Value: 1.1 }, # Penalize repeated tokens (0-2.0)
            { Name: num_gpu, Value: 40 }, # Number of layers to offload to GPU
          ]
        # -----------------------------------------
        # 7,907 characters
        # 1,543 tokens https://token-calculator.net
        # -----------------------------------------
        UserPrompt: &FilterPrompt |
          This message was sent between an aircraft and air traffic control. Rarely,
          messages like these have prose at the end is interesting to air travel
          enthusiasts because it was was written by a pilot or air traffic
          controllers instead of generated by an automated system on the aircraft or
          at ATC. The messages they care about most often read like short instant
          messages or text messages and words may be abbreviated (THX for THANKS or
          WHLCHAIRS for WHEELCHAIRS, for example) or misspelled, which suggests a
          human wrote it and therefore is of interest. Questions asked in natural
          language are definitely of interest because automated systems will not ask
          questions using prose. Air travel enthusiasts want to see friendly or
          casual messages between pilots and ATC because that is air travel
          communication that is not actually related to air travel, which provides a
          behind-the-scenes look into the day-to-day minutiae of air travel
          professionals.

          Prose that air travel enthusiasts want to see may have newlines, spaces or
          other characters in the middle of words or may be missing spaces between
          words which is due to human typos which are common.

          If a message has prose that comes across as dramatic, friendly, angry,
          alarmed, scared, stressed, or otherwise seems emotional then it is
          definitely something air travel enthusiasts want to see because they are
          interested in the interactions of people behind the scenes of air travel.
          Informal, friendly, jovial or casual communication is also of interest to
          air travel enthusiasts because those messages show a behind-the-scenes
          peek into the day-to-day interactions of the people who work in air
          travel.

          If prose in the message discusses a situation notable to the pilots, the
          crew, or the passengers, air travel enthusiasts want to see it because
          they care about people involved in air travel. Some examples of elements
          notable to pilots, the crew or passengers are emergencies, life vests,
          wheelchairs (often abbreviated, such as WCHR), biohazards and cleanup,
          passengers (the shorthand PAX is used), bad weather (known as SIGMET),
          special situations (for example, an aircraft with only one passenger or a
          request that looks like it's for a VIP), cabin equipment on the aircraft
          such as coffee makers, chairs or lavatories (shorthand: LAV). Sometimes,
          messages will talk about sports, such as asking for current sports scores,
          so the pilots can relay them to their passengers. This is the type of
          message air travel enthusiasts will want to know about because it is air
          travel communication not related to air travel.

          If a message has FL and then 3 numbers and talks about "SMOOTH" or "CHOP",
          it's referring to the smoothness of the flight level and is communication
          from a pilot to other pilots. Since the message comes from a pilot,
          air travel enthusiasts are interested in seeing it.

          If the message talks about gate assignments, that was sent by a pilot
          because pilots need to know which gate to bring their aircraft to and air
          travel enthusiasts want to see those kinds of messages.

          If the message has any of these strings, then air travel enthusiasts
          definitely want to see it because only humans will use these terms.

          - BINGO
          - CHOP
          - COMMENTS
          - CONFIRM
          - DEFECT
          - DISP
          - EVENING
          - FREETEXT
          - FTM
          - INOP
          - MEET
          - MSG FROM
          - PAN PAN
          - PAN-PAN
          - PAX
          - POTABLE
          - TEXT
          - THANKS
          - THX
          - TXT

          Here's an example message air travel enthusiasts want to see:
          ```
          C313YYZ        1PAX IN 22C WAS VAPING. P
          LEASE HAVE CSM MEET US.
          HE APOLOGIZED.
          CHEERS ALEX
          ```

          This is interesting to them because:

          - It mentions a passenger (PAX) was vaping, which is against the law to do
          on aircraft. Air travel enthusiasts are interested in situations where
          rules or laws are being broken.
          - It mentions the passenger apologizing. This adds a human element to the
          events and makes the message more interesting because air travel
          enthusiasts like drama.
          - It has "CHEERS ALEX" which is a friendly phrase written by a person.
          Any friendly greetings or closings such as "THANKS", "GOOD MORNING",
          "GOOD EVENING", "HELLO", or others were definitely written by a person and
          air travel enthusiasts want to see those messages.

          This is a harder message because it is extremely short, but it is still
          something air travel enthusiasts are interested in seeing:

          ```
          171730  CHS  JFK3
                    A
          WIND 50 KTS STRONGER THAN PLANNED
          ```

          The prose in the message starts with "WIND 50 KTS STRONGER...", which
          describes a potentially dangerous or harrowing situation, since strong
          winds are dangerous to an aircraft. The message was also clearly
          human-written since a generated report would not include interpretation or
          commentary such as "STRONGER THAN PLANNED". This is definitely a message
          air traffic enthusiasts want to see. It is also very brief, which is
          typical of the human prose in these messages.

          This is the last example of meaningful communication:
          ```
          3A01 OPSCTL 0364/14 KRSW/KHVN .N804VL
          TELL ROMAN TO SLOW DOWN
          LOL WE ARE GONNA
          TRY AND MAKE SOME TIME
          ```

          The presence of OPS means it's probably bespoke prose to or from
          Operations and therefore of interest. The message then has a humorous and
          friendly message asking Roman to slow down and adding that they are going
          to try to make some time. Since automatically generated messages don't use
          English shorthand (LOL) or describe planned future actions, this is 
          definitely something air travel enthusiasts want to see.

          This is a message an air travel enthusiast is NOT interested in:

          ```
          POSN36188W077155,GUILD,022722,335,DEEEZ,023833,ESCHR,M49,27459,
          154A785RESREQ/AK,1158AF6PER/PR1326,303,360,153,,0,53,,M56,180,,,
          P40,P0,36090,,1173,31729A4RESREQ/AK,1158AF6FPN/FNAAL2816/RP:DA:
          KDCA:AA:KJAX:CR:KDCAKJAX:R:19O(26O):D:AMEEE1.SCOOB:A:LUNNI1.
          ESENT:AP:ILSY26..GUILD,N36188W077150.Q409.SESUE..ESENT,
          N32095W080551:V:ESENT,,AA2800,5F52
          ```

          This is looks like raw diagnostic data that requires software to
          understand that a hobbyist would NOT care about. Air travel enthusiasts
          want to see messages from people and messages written by people are more
          free-form, may contain errors and read more like a natural conversation or
          prose. This message is highly structural so air travel enthusiasts don't
          want to see this message.

          This is another example of a message that air travel enthusiasts don't
          want to see:

          ```
          PAGE 00001
          MDC REPORT: ENGINE TREND
          WRITE OPTION: ACARS AUTO
          FILENAME: AC15315J.ETD
          TIME: 22:36
          DATE: 17Apr2025
          MDC APPLICATION PN: 832-6207-426
          MDC TABLES PN:      810-0042-115


          LEG:18226  DATE:17APR25 TIME:22:36

          ------------------------------------
          L N1                      84.8 %
          R N1                      84.8 %
          L N2                      88.4 %
          R N2                      88.1 %
          L ITT                      831 C
          R ITT                      839 C
          L PS3                      293 PSI
          R PS3                      289 PSI
          L N1 VIBES                 0.3 MIL
          R N1 VIBES                 0.1 MIL
          L N2 VIBES                 0.2 MIL
          R N2 VIBES                 0.2 MIL
          L OIL TEMP                  75 C
          R OIL TEMP                  78 C
          L OIL PRESSURE              78 PSI
          R OIL PRESSURE              77 PSI
          L PLA                     51.3 DEG
          R PLA                     50.8 DEG
          L FUEL FLOW               4625 PPH
          R FUEL FLOW               4631 PPH
          L VG POSITION              0.5 DEG
          R VG POSITION              1.0 DEG
          FADEC IN CONTROL         LB AND RB
          COMPUTED AIRSPEED        155.1 KT
          ALTITUDE                    96 FT
          TOTAL AIR TEMP            17.5 C
          L FADEC BLEED STATUS      1044 INT
          R FADEC BLEED STATUS      1044 INT
          ```

          Based on the large amount of sensors and readings in this message, this is
          clearly a periodic report which has a lot of sensor readings. This IS NOT
          something an air travel enthusiast wants to see because a message that
          only has data from sensors is not prose written by a person. The majority
          of this message is in two columns (achieved by adding spaces) when using
          a monospace font which should strongly indicate it's a automatically
          generated report rather than freehand prose written by a human and
          therefore is not interesting to air travel enthusiasts.

          This is part of a similar message that air travel enthusiasts do not want
          to see:
          ```
          L ITT                      880 C
          R ITT                      874 C
          L PS3                      292 PSI
          R PS3                      297 PSI
          ```

          Any message that looks like it's listing out sensors and values for the
          sensors with specific spacing like this message for multiple consecutive
          lines or more is not what air travel enthusiasts want to see.

          This is another example message that air traffic enthusiasts do not want
          to see:
          ```
          FPN/RP:DA:KLGA:AA:KMCO:CR:KLGAKMCO(35R)..MOXXY.Q85.LPERD:A:
          SNFLD3.LPERD:F:VECTOR..DISCO..FESHA:AP:ILS 35R:F:PRESKCC4E
          ```

          This message has a lot of English words but when they are read the
          sentence seems like gibberish. Since it's not prose (even informal prose)
          and therefore did not come from a person, air travel enthusiasts do not
          want to see it.

          If the message has any of these strings, it is NOT relevant to air traffic
          enthusiasts since these strings are only used for unimportant messages:

          - SLAT DIS PROX
          - FPN/
          - FILENAME
          - LRU SIGNAL CONDITIONER UNIT
          - LRU
          - LRU NAME
          - POSRPT
          - PROX
          - P/N
          - ATA21-61 TEMPERATURE CONTROL
          - BOARDING HELD
          - SHUTDOWN THE APU
          - YOU HAVE INFO
          - GATE REQ
          - IN VICINITY OF AIRPORT
          - ARRIVAL GATE INFORMATION

          Air travel enthusiasts don't want to see departure delay reports usually 
          because they are common and often unremarkable in air travel. They will 
          have "BOARDING HELD" in the message. If the report has anything written
          after the phrase COMMENTS however, those are always written by a person
          and that means air travel enthusiasts definitely want to see the message
          in this case even though it's a departure delay report because the
          additional comments will always be noteworthy and of interest.

          Air travel enthusiasts do not want to see a message that looks like data
          rather than conversational prose.

          Based on what I've told you, is this message something you're certain that
          an air travel enthusiast would want to see?
      #      /no_think

  - Annotate:
      SelectedFields:
        - ACARSProcessor.ACARSDramaTailNumberLink
        - ACARSProcessor.AircraftDistanceMi
        - ACARSProcessor.FrequencyMhz
        - ACARSProcessor.From
        - ACARSProcessor.ImageLink
        - ACARSProcessor.MessageText
        - ACARSProcessor.PhotosLink
        - ACARSProcessor.SignalLeveldBm
        - ACARSProcessor.ThumbnailLink
        - ACARSProcessor.TrackingLink
        - ACARSProcessor.TranslateLink
        - ACARSProcessor.UnixTimestamp

  - Send:
      Discord:
        Embed: true
        # EmbedColorFacetFields: [ACARSProcessor.From]
        EmbedColorGradientField: ACARSProcessor.LLMNumberResult
        URL: "${acars_discord_webhook}"
        FormatText: true
        FormatTimestamps: true

  - Send:
      <<: *newrelic
      NewRelic: { CustomEventType: CustomACARSHumanMessages }

  - Annotate:
      Ollama:
        Model: *ollamamodel
        URL: *ollamaurl
        MaxRetryAttempts: 2
        MaxRetryDelaySeconds: 5
        Timeout: 30
        Options: *ollamaopts
        UserPrompt: |
          Rate the prose found in this message on a scale of 1-100 for
          emotionality with 1 meaning it reads as unemotional and/or neutral
          with no positive or negative emotions and 100 meaning it reads as
          extremely emotional in either a positive or negative way. Ignore any
          parts of the message that don't have natural prose.

          Examples and suggested ratings:
          ```
          211530 KMCO KDCA7
          /FN 2370
          A      
          MOSTLY SMOOTH ALL DAY
          ```
          This message would be about a 10 since there are no emotional words
          used, but the situation being reported is a positive one (MOSTLY
          SMOOTH ALL DAY)

          Is the result greater than 20?
        SelectedFields: 
          - ACARSProcessor.LLMProcessedNumber
          - ACARSProcessor.LLMQuestionAnswer
          - ACARSProcessor.LLMProcessedText
          - ACARSProcessor.LLMFeedbackText

  - Filter:
      SelectedFields:
        - ACARSProcessor.LLMProcessedNumber
        - ACARSProcessor.LLMQuestionAnswer
        - ACARSProcessor.LLMFeedbackText

  - Send:
      Discord:
        Embed: true
        # EmbedColorFacetFields: [ACARSProcessor.From]
        EmbedColorGradientField: ACARSProcessor.LLMProcessedNumber
        URL: "${acars_anger_discord_webhook}"
        FormatText: true
        FormatTimestamps: true
